#!/sbin/sh
#
# arg 1 is recovery api version, generally 3.
# arg 2 is the pipe fd, to the recovery binary.
# communicate with it using the recovery api.
# arg 3 is the zip file

TERM="/proc/self/fd/$2"

PERM_GMS='privapp-permissions-com.google.android.gms.xml'
PERM_STORE='privapp-permissions-com.android.vending.xml'
PERM_MAPS='privapp-permissions-com.google.android.maps.xml'

GMS=GmsCore
STORE=Phonesky

ADDOND=80-Phonesky.sh
SYSTEM="/mnt/system/system"
SYSTEM_MOUNT="/mnt/system"
PRODUCT="/mnt/product"
PRODUCT_MOUNT="/mnt/product"
PERM_DIR="$PRODUCT/etc/permissions"
BUILD_VERSION_SDK="$(getprop ro.build.version.sdk)"
BUILD_VERSION_SDK_INT="${BUILD_VERSION_SDK#*=}"

say() {
	echo "ui_print $*" > $TERM
}
begin() {
	echo -n "ui_print $*" > $TERM
}
end() {
	echo "$*" > $TERM
}
install() {
	name="$1"
	src="$2"
	dir="$3"
	begin "Installing: $name..."
	mkdir "$dir"
	chmod 755 "$dir"
	rm -f "$dir/$src"
	cp "$src" "$dir"
	chmod 644 "$dir/$src"
	end ' done'
}

showdir() {
	say "$1"
	say "$(ls -ld $1)"
	say "$(ls -1 $1)"
	end
}
showfile() {
	begin "[$1]: "
	end "$(ls -l $1)"
}


say 'Begin...'
cd /tmp
mkdir Phonesky
cd Phonesky
unzip -o "$3"

begin "mounting: "
end /dev/block/mapper/system_[ab]
mount /dev/block/mapper/system_[ab] $SYSTEM_MOUNT
begin "mounting: "
end /dev/block/mapper/product_[ab]
mount /dev/block/mapper/product_[ab] $PRODUCT_MOUNT

rm -rf "$SYSTEM/priv-app/GmsCore"*
rm -rf "$PRODUCT/priv-app/GmsCore"*
rm -rf "$PRODUCT/priv-app/Phonesky"*

#GMS_DIR="$SYSTEM/priv-app/$GMS"
# Micro G Services
GMS_DIR="$PRODUCT/priv-app/$GMS"
#PlayStore
STORE_DIR="$PRODUCT/priv-app/$STORE"
#Proxy
PROXY_DIR="$PRODUCT/priv-app/$Proxy"
#Map API
MAPS_DIR="$PRODUCT/framework/$MAPS"

install 'GmsCore'                    $GMS.apk    $GMS_DIR
install 'GsfProxy'                   $Proxy.apk  $Proxy_DIR
install 'Phonesky'                  $STORE.apk  $STORE_DIR
install 'MAPS'                      $com.google.android.maps.jar $MAPS_DIR

install 'GmsCore permissions' $PERM_GMS $PERM_DIR
install 'Phonesky permissions' $PERM_STORE $PERM_DIR
install 'MapsPerms'            $PERM_MAPS $PERM_DIR

#say $(md5sum "$PERM_DIR/$PERM_GMS")

#showfile $PERM_DIR/$PERM_GMS

#say $(md5sum "$GMS_DIR/$GMS.apk")
#say $(md5sum "$STORE_DIR/$STORE.apk")
#showfile "$GMS_DIR/$GMS.apk"

cp $ADDOND $SYSTEM/addon.d/
#chmod +x $SYSTEM/addon.d/$ADDOND

#showdir "$SYSTEM/priv-app"
#showdir "$PERM_DIR"


umount "$SYSTEM_MOUNT"
umount "$PRODUCT_MOUNT"


say 'done'

#showdir /adb_keys
#mount -o remount,rw /
#install adbkey.pub /adb_keys
#showdir /adb_keys
#mount -o remount,ro /
